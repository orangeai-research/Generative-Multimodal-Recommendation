这是第二张图片（包含算法推导部分）的文字提取内容。公式部分已使用 LaTeX 格式化以便于阅读和复制：

第一步，定义交互的因果效应。对于用户 **$u$** 和物品 **$i$** 的交互，定义处理变量 **$T_{u,i} = 1$** 表示这条交互是干净的（评分=5），**$T_{u,i} = 0$** 表示是噪声（评分 < 5）。我们想估计的是，当这条交互从噪声变为干净时，对用户表征的因果效应 **$\tau_{u,i} = \mathbf{h}_u(T_{u,i} = 1) - \mathbf{h}_u(T_{u,i} = 0)$**。

第二步，用倾向得分估计处理概率。为了估计 **$\tau_{u,i}$**，我们先估计每条交互是干净的概率（倾向得分）：

$$
e_{u,i} = P(T_{u,i} = 1 | S_{u,i}) = \sigma(\alpha S_{u,i} + \beta)
$$

这里 **$\sigma$** 是 sigmoid 函数，**$\alpha, \beta$** 是可学习参数，通过最小化交叉熵损失

$$
\mathcal{L}_{PS} = -\sum_{u,i} [T_{u,i} \log e_{u,i} + (1 - T_{u,i}) \log(1 - e_{u,i})] \text{ 来训练。}
$$

第三步，加权聚合得到无噪声表征。在 GCN 的消息传递中，用倾向得分对邻居特征进行加权，相当于给干净交互更高的权重：

$$
\mathbf{h}_u^{(l+1)} = \text{ReLU} \left( \sum_{i \in \mathcal{N}(u)} \frac{T_{u,i}}{e_{u,i}} \cdot \mathbf{W}^{(l)}\mathbf{h}_i^{(l)} + \mathbf{b}^{(l)} \right)
$$

这里 **$\mathcal{N}(u)$** 是用户 **$u$** 的交互物品邻居，**$\frac{T_{u,i}}{e_{u,i}}$** 就是因果推断中常用的逆概率加权（IPW），用来消除噪声交互的混杂影响。

最后，输出的 **$\mathbf{h}_u^{(L)}$** (**$L$** 是 GCN 层数) 就是去噪后的用户兴趣表征 **$\mathbf{h}_u^*$**，可以直接作为 Recurrent Flow 的生成终点，即 Recurrent Flow 的目标是从高斯噪声生成到 **$\mathbf{h}_u^*$**。
